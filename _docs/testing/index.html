<h1>Testing</h1><p>We highly recommend working in the style of <a href="http://agiledata.org/essays/tdd.html">test-driven development</a> when creating probot apps. It is frustrating to constantly create real GitHub events in order to test an app. Redelivering webhooks is possible and can be accessed in your app's <a href="https://github.com/settings/apps">settings</a> page under the <strong>Advanced</strong> tab. We do offer the above documented <code>receive</code> method to help make this easier; however, by writing your tests first, you can avoid repeatedly recreating actual events from GitHub to check if your code is working.</p><p>For our testing examples, we use <a href="https://facebook.github.io/jest/">jest</a>, but there are other options that can perform similar operations. We also recommend using <a href="https://github.com/nock/nock">nock</a>, a tool for mocking HTTP requests, which is often crucial to testing in Probot, considering how much of Probot depends on GitHub's APIs. Here's an example of creating an app instance and using nock to test that we correctly hit the GitHub API:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> nock <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"nock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Requiring our app implementation</span><br><span class="token keyword">const</span> myProbotApp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">".."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token punctuation">{</span> Probot<span class="token punctuation">,</span> ProbotOctokit <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"probot"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Requiring our fixtures</span><br><span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./fixtures/issues.opened"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> issueCreatedBody <span class="token operator">=</span> <span class="token punctuation">{</span> body<span class="token operator">:</span> <span class="token string">"Thanks for opening this issue!"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"My Probot app"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> probot<span class="token punctuation">;</span><br><br>  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    nock<span class="token punctuation">.</span><span class="token function">disableNetConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    probot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Probot</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      githubToken<span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span><br>      <span class="token comment">// Disable throttling &amp; retrying requests for easier testing</span><br>      Octokit<span class="token operator">:</span> ProbotOctokit<span class="token punctuation">.</span><span class="token function">defaults</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        retry<span class="token operator">:</span> <span class="token punctuation">{</span> enabled<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        throttle<span class="token operator">:</span> <span class="token punctuation">{</span> enabled<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">myProbotApp</span><span class="token punctuation">(</span>probot<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"creates a passing check"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// Test that we correctly return a test token</span><br>    <span class="token function">nock</span><span class="token punctuation">(</span><span class="token string">"https://api.github.com"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/app/installations/2/access_tokens"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">reply</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> token<span class="token operator">:</span> <span class="token string">"test"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Test that a comment is posted</span><br>    <span class="token function">nock</span><span class="token punctuation">(</span><span class="token string">"https://api.github.com"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/repos/hiimbex/testing-things/issues/1/comments"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">body</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token function">expect</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchObject</span><span class="token punctuation">(</span>issueCreatedBody<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">reply</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Receive a webhook event</span><br>    <span class="token keyword">await</span> probot<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"issues"</span><span class="token punctuation">,</span> payload <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    nock<span class="token punctuation">.</span><span class="token function">cleanAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    nock<span class="token punctuation">.</span><span class="token function">enableNetConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2>Testing log output</h2><p>Probot is using <a href="https://getpino.io/">pino</a> for logging. A custom <code>pino</code> instance can be passed to the <code>Probot</code> constructor. You can write all log output into an array by passing a custom transport function:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> pino <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"pino"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> Stream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"stream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> streamLogsToOutput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stream<span class="token punctuation">.</span>Writable</span><span class="token punctuation">(</span><span class="token punctuation">{</span> objectMode<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>streamLogsToOutput<span class="token punctuation">.</span><span class="token function-variable function">_write</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  output<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> probot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Probot</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>  githubToken<span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span><br>  <span class="token comment">// Disable throttling &amp; retrying requests for easier testing</span><br>  Octokit<span class="token operator">:</span> ProbotOctokit<span class="token punctuation">.</span><span class="token function">defaults</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    retry<span class="token operator">:</span> <span class="token punctuation">{</span> enabled<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    throttle<span class="token operator">:</span> <span class="token punctuation">{</span> enabled<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  log<span class="token operator">:</span> <span class="token function">pino</span><span class="token punctuation">(</span>streamLogsToOutput<span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>probot<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// output is now:</span><br><span class="token comment">// [ { level: 30, time: 1600619283012, pid: 44071, hostname: 'Gregors-MacBook-Pro.local', msg: 'test' } ]</span></code></pre><h2>Examples:</h2><p>Using Jest</p><ul><li><a href="https://github.com/probot/settings">Settings</a>: <a href="https://github.com/probot/settings/blob/master/test/integration/plugins/repository.test.js">probot/settings/test/integration/plugins/repository.test.js</a></li><li><a href="https://github.com/probot/dco">DCO</a>: <a href="https://github.com/probot/dco/blob/master/test/index.test.js">probot/dco/test/index.test.js</a></li></ul><p>Using Tap</p><ul><li><a href="https://github.com/apps/wip/">WIP</a>: <a href="https://github.com/wip/app/tree/master/test/integration">wip/app/test/integration</a></li></ul>